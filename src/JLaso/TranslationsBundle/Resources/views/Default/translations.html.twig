{% extends '::base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style type="text/css">
        input.transparent{
            background: transparent;
        }
    </style>
{% endblock stylesheets %}


{% macro node(nodes) %}
    <ul>
        {% for key,item in nodes %}
            <li id="phtml_{{ loop.index }}">
                <a href="#" class="key-tree-node" key="{{ item }}">{{ key }}</a>
                {{ _self.node(item) }}
            </li>
        {% endfor %}
    </ul>
{% endmacro %}


{# cron periodico para releer si hay cambios por parte de otro usuario o de la api #}

{% block sidebar %}
    <div class="span2">
        <div class="well sidebar-nav">
            <ul class="nav nav-list">
                <li>
                    <h3>{{ "bundles"|trans|raw }}</h3>
                </li>
                <li>
                    <div class="accordion" id="accordion_sidebar">
                        {% for bundle in bundles %}
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a style="text-decoration: none;text-align: left"
                                   class="accordion-toggle btn {{ current_bundle==bundle ? 'btn-danger' : '' }}"
                                   href="{{ path('translations', {'projectId':project.id, 'bundle':bundle, 'catalog':'messages'}) }}">
                                    <i class="icon-tasks {{ current_bundle==bundle ? 'icon-white' : '' }}"></i>
                                    <span> {{ bundle }}</span>
                                </a>
                            </div>
                            {#{% if current_bundle == bundle %}
                            <div id="collapse_bundle_{{ bundle }}" class="accordion-body collapse in">
                                <div class="container">
                                    {{ _self.node(keys) }}
                                </div>
                            </div>
                            {% endif %}#}
                        </div>
                        {% endfor %}
                    </div>
                </li>
            </ul>
        </div><!--/.well -->

        <div class="well">
            <div class="accordion" id="accordionEvent">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a style="text-align: left;text-decoration: none" class="accordion-toggle btn btn-danger"
                           data-toggle="collapse" data-parent="#accordion2" href="#collapseEvent">
                            <i class="icon-warning-sign"></i> Event <i class="icon-minus pull-right"></i>
                        </a>
                    </div>
                    <div id="collapseEvent" class="accordion-body collapse in">
                        <div class="accordion-inner" style="background-color: #ffffff;" id="event_list">

                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!--/span-->


    </div><!--/span-->
{% endblock sidebar %}

{% block breadcrum %}
{#    <div class="row-fluid">
        <h2 class="span4">{{ project.project }}</h2>
        {% set breadcrum = [ {'label':'Home','url':'/'}, {'label':'Tables', 'url':'/'} ] %}
        <ul class="breadcrumb pull-right">
            {% for step in breadcrum %}
                <li>
                    <a href="{{ step.url }}">
                        {{ step.label }}
                    </a> <span class="divider">/</span>
                </li>
            {% endfor %}
        </ul>
    </div>#}
{% endblock breadcrum %}

{% block content %}
<div class="span3">

    <div class="row-fluid">
        <div class="btn span12">
            {{ current_bundle }}
        </div>
        <div class="span12">
            <input type="text" name="search" placeholder="search..."/>
        </div>
    </div>

    <div class="row-fluid">
        <div id="bundle-keys" class="span12">
            {{ _self.node(keys) }}
        </div>
    </div>

</div>

<div class="span9">

    {% for info in trans_data %}

        <div class="translations-group row-fluid" id="key-{{ info.id_html }}" {{ current_key==info.key ? '' : 'style="display: none;"' }}>
            <div class="span12">
                <div class="row-fluid">
                    <div style="text-align: left;" class="span12 btn">
                        <i class="icon-list"></i> {{ info.key }} &nbsp;<i class="icon-comment"></i> <span id="comment-{{ info.id_html }}">{{ info.comment }}</span>
                    </div>
                </div>
                <div class="row-fluid" style="background-color: #ffffff;">
                    <table cellpadding="0" cellspacing="0" border="0"
                           class="table table-striped table-bordered" id="example">
                        <thead>
                        <tr>
                            <th>{{ "label.language"|trans|raw }}</th>
                            <th>{{ "label.message"|trans|raw }}</th>
                            <th>{{ "label.actions"|trans|raw }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr id="comment-{{ info.id }}" class="comment-row">
                            <td><i class="icon-comment"></i>&nbsp;{{ "label.comment"|trans|raw }}</td>
                            <td><input type="text" class="span12" value="{{ info.comment }}"/></td>
                            <td>
                                <a href="#" class="btn btn-primary save-comment"
                                   data-role="#comment-{{ info.id }}" key="{{ info.key }}">
                                    <i class="icon-save"></i> {{ "button.save"|trans|raw }}
                                </a>
                            </td>
                        </tr>
                        {% for lang in managed_languages %}
                            <tr class="key-row {{ cycle('odd', 'even') }} gradeX" id="key-{{ info.id }}-{{ lang }}">
                                <td class="center">
                                    <i class="icon-flag"></i>&nbsp;<code>{{ lang }}</code>
                                    <img src="{{ asset('bundles/translations/img/flags/' ~ lang ~ '.png') }}" alt="{{ lang }} flag"/>
                                    &nbsp;{{ languages[lang].name }}
                                </td>
                                <td>
                                    <textarea class="span12" rows="2" dir="{{ languages[lang].dir }}">
                                        {{- info.messages[lang] is defined ? info.messages[lang] : '' -}}
                                    </textarea>
                                </td>
                                <td>
                                    <a href="#" class="btn btn-primary save-message"
                                            data-role="#key-{{ info.id }}-{{ lang }}"
                                            language="{{ lang }}" key="{{ info.key }}">
                                        <i class="icon-save"></i> {{ "button.save"|trans|raw }}
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div><!-- class=translations-group -->
    {% endfor %}

</div>
{% endblock content %}

{% block javascripts %}
    <script type="text/javascript">

        function logEvent(message)
        {
            var fecha = new Date();
            var html = '<div class="row-fluid">' +
                       '<span class="label label-warning pull-right">' + fecha + '</span>' +
                       '</div>' +
                       '<div class="row-fluid">'+
                       '<p>'  + message + '</p>' +
                       '</div>' +
                       '<hr>';
            $('#event_list').append(html);
        }

        var current = null;
        var interval = null;

        function saveMessage(id)
        {
            var message = $(id).find('textarea').val();
            var button  = $(id).find('a.btn');
            current = button;
            interval = setInterval(function() { $(current).toggleClass('btn-primary'); }, 80);
            var data = {
                bundle: '{{ current_bundle }}',
                language: $(button).attr('language'),
                key: $(button).attr('key'),
                message: message
            };
            //console.log(data); return;
            $.ajax({
                type: 'post',
                url: '{{ path('save_message', {'projectId': project.id}) }}',
                data: data,
                success: function(data){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    console.log(data);
                    if(data=='OK'){

                    }else{
                        logEvent(data);
                    }
                },
                error: function(){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    logEvent('Error');
                }
            });
        }

        function saveComment(id)
        {
            var comment = $(id).find('input').val();
            var button  = $(id).find('a.btn');
            current = button;
            interval = setInterval(function() { $(current).toggleClass('btn-primary'); }, 80);
            var data = {
                bundle: '{{ current_bundle }}',
                key: $(button).attr('key'),
                comment: comment
            };
            //console.log(data); return;
            $.ajax({
                type: 'post',
                url: '{{ path('save_comment', {'projectId': project.id}) }}',
                data: data,
                success: function(data){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    console.log(data);
                    if(data.result){
                        $("#comment-"+data.id_html).html(data.comment);
                    }else{
                        logEvent(data);
                    }
                },
                error: function(){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    logEvent('Error');
                }
            });
        }

        $(function(){

            $('.accordion-heading').click(function(e){
                $('.accordion-body.in').collapse('toggle');
            });
            /*$.ajaxComplete = function(){
                console.log('complete');
                if(current!=null){
                    $(current).removeClass('btn-danger').addClass('btn-primary');
                    current = null;
                }
            }

            $.ajaxStart = function(){
                console.log('start');
                if(current != null){
                    $(current).removeClass('btn-primary').addClass('btn-danger');
                };
            }*/

            /*$(".save-message").click(function(e){
                e.preventDefault();
                var id = $(this).attr('data-role');
                saveMessage(id);
            });*/

            /*$(".key-row textarea").blur(function(e){
                e.preventDefault();
                if ($(this).hasChanged()){
                    console.log('bluring...');
                    var id = $(this).parent().find('a.btn').attr('data-role');
                    saveMessage(id);
                }
            });*/

            $(".key-row textarea").change(function(e){
                e.preventDefault();
                console.log('bluring...');
                var id = $(this).parent().parent().find('a.btn').attr('data-role');
                saveMessage(id);
            });

            $(".comment-row input").change(function(e){
                e.preventDefault();
                console.log('bluring...');
                var id = $(this).parent().parent().find('a.btn').attr('data-role');
                saveComment(id);
            });

            $("#bundle-keys").jstree({
                "plugins" : [ "themes", "html_data" ]
            });

            $('#bundle-keys').on('click','.key-tree-node',function(e){
                e.preventDefault();
                var key = $(this).attr('key');
                console.log('showing '+key+' ...');
                var dest = $('#key-'+key);
                if(dest){
                    $('.key-tree-node').removeClass('btn btn-danger');
                    $(this).addClass('btn btn-danger');
                    $('.translations-group').hide();
                    $(dest).show();
                }
            });

        });
    </script>
{% endblock javascripts %}