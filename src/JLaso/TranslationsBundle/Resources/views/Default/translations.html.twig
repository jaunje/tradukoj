{% extends '::base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style type="text/css">
        input.transparent{
            background: transparent;
        }
    </style>
{% endblock stylesheets %}


{% macro node(nodes) %}
    <ul>
        {% for key,item in nodes %}
            <li id="phtml_{{ loop.index }}">
                <a href="#" class="key-tree-node" key="{{ item is iterable ? '' : item }}">{{ key }}</a>
                {{ _self.node(item) }}
            </li>
        {% endfor %}
    </ul>
{% endmacro %}


{# cron periodico para releer si hay cambios por parte de otro usuario o de la api #}

{% block sidebar %}
    <div class="span2">
        <div class="well sidebar-nav">
            <ul class="nav nav-list">
                <li>
                    <h3>{{ "catalogs"|trans|raw }}</h3>
                </li>
                <li>
                    <div class="accordion" id="accordion_sidebar">
                        {% for catalog in catalogs %}
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a style="text-decoration: none;text-align: left"
                                   class="accordion-toggle btn {{ current_catalog==catalog ? 'btn-danger' : '' }}"
                                   href="{{ path('translations', {'projectId':project.id, 'catalog':catalog}) }}">
                                    <i class="icon-tasks {{ current_catalog==catalog ? 'icon-white' : '' }}"></i>
                                    <span> {{ catalog }}</span>
                                </a>
                            </div>
                            {#{% if current_catalog == bundle %}
                            <div id="collapse_bundle_{{ bundle }}" class="accordion-body collapse in">
                                <div class="container">
                                    {{ _self.node(keys) }}
                                </div>
                            </div>
                            {% endif %}#}
                        </div>
                        {% endfor %}
                    </div>
                </li>
            </ul>
        </div><!--/.well -->

        <div class="well">
            <div class="accordion" id="accordionEvent">
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a style="text-align: left;text-decoration: none" class="accordion-toggle btn btn-danger"
                           data-toggle="collapse" data-parent="#accordion2" href="#collapseEvent">
                            <i class="icon-warning-sign"></i> Event <i class="icon-minus pull-right"></i>
                        </a>
                    </div>
                    <div id="collapseEvent" class="accordion-body collapse in">
                        <div class="accordion-inner" style="background-color: #ffffff;" id="event_list">

                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!--/span-->


    </div><!--/span-->
{% endblock sidebar %}

{% block breadcrum %}
{#    <div class="row-fluid">
        <h2 class="span4">{{ project.project }}</h2>
        {% set breadcrum = [ {'label':'Home','url':'/'}, {'label':'Tables', 'url':'/'} ] %}
        <ul class="breadcrumb pull-right">
            {% for step in breadcrum %}
                <li>
                    <a href="{{ step.url }}">
                        {{ step.label }}
                    </a> <span class="divider">/</span>
                </li>
            {% endfor %}
        </ul>
    </div>#}
    {# permissions|ld #}
{% endblock breadcrum %}

{% block content %}
<div class="span3">

    <div class="row-fluid">
        <div class="btn span12">
            {{ current_catalog }}
        </div>
        <div class="span12">
            <input type="text" name="search" placeholder="search..."/>
            <a href="#" class="btn btn-primary" id="search"><i class="icon icon-search"></i></a>
        </div>
    </div>

    <div class="row-fluid">
        <div id="bundle-keys" class="span12">
            {{ _self.node(keys) }}
        </div>
    </div>

</div>

<div class="span9" id="translations-group">

    {# messages detail #}

</div>
{% endblock content %}

{% block javascripts %}
    <script type="text/javascript">

        var currentKey = null;

        function logEvent(message)
        {
            var fecha = new Date();
            var html = '<div class="row-fluid">' +
                       '<span class="label label-warning pull-right">' + fecha + '</span>' +
                       '</div>' +
                       '<div class="row-fluid">'+
                       '<p>'  + message + '</p>' +
                       '</div>' +
                       '<hr>';
            $('#event_list').append(html);
        }

        var current = null;
        var interval = null;
        var idTemp = null;

        function saveMessage(id)
        {
            if(!currentKey) return false;
            console.log(id);
            idTemp = id;
            var message = $(id).parent().find('textarea').val();
            var button  = $(id).find('a.btn');
            current = button;
            interval = setInterval(function() { $(current).toggleClass('btn-primary'); }, 80);
            var data = {
                catalog: '{{ current_catalog }}',
                locale: $(id).attr('locale'),
                key: currentKey,
                message: message
            };
            console.log(data);
            $.ajax({
                type: 'post',
                url: '{{ path('save_message', {'projectId': project.id}) }}',
                data: data,
                success: function(data){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    //console.log(data);
                    if(data.result){
                        $(id).parent().find('textarea').val(data.message);
                    }else{
                        logEvent(data.reason);
                    }
                },
                error: function(){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    logEvent('Error');
                }
            });
        }

        function saveComment(id)
        {
            var comment = $(id).find('input').val();
            var button  = $(id).find('a.btn');
            current = button;
            interval = setInterval(function() { $(current).toggleClass('btn-primary'); }, 80);
            var data = {
                bundle: '{{ current_catalog }}',
                key: $(button).attr('key'),
                comment: comment
            };
            //console.log(data); return;
            $.ajax({
                type: 'post',
                url: '{{ path('save_comment', {'projectId': project.id}) }}',
                data: data,
                success: function(data){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    console.log(data);
                    if(data.result){
                        $("#comment-"+data.id_html).html(data.comment);
                    }else{
                        logEvent(data);
                    }
                },
                error: function(){
                    clearInterval(interval);
                    $(current).addClass('btn-primary');
                    logEvent('Error');
                }
            });
        }

        $(function(){

            $('.accordion-heading').click(function(e){
                $('.accordion-body.in').collapse('toggle');
            });

            $("#translations-group").on("click", ".save-message", function(e){
                e.preventDefault();
                console.log('saving-message');
                saveMessage($(this).parent());
            });

            /*$(".key-row textarea").blur(function(e){
                e.preventDefault();
                if ($(this).hasChanged()){
                    console.log('bluring...');
                    var id = $(this).parent().find('a.btn').attr('data-role');
                    saveMessage(id);
                }
            });*/

            $(".key-row textarea").change(function(e){
                e.preventDefault();
                console.log('bluring...');
                var id = $(this).parent().parent().find('a.btn').attr('data-role');
                saveMessage(id);
            });

            $(".comment-row input").change(function(e){
                e.preventDefault();
                console.log('bluring...');
                var id = $(this).parent().parent().find('a.btn').attr('data-role');
                saveComment(id);
            });

            $("#bundle-keys").jstree({
                "plugins" : [ "themes", "html_data" ]
            });

            var currentNode = null;
            $('#bundle-keys').on('click','.key-tree-node',function(e){
                e.preventDefault();
                var key = $(this).attr('key'); //.replace(" ","-");
                if(!key) {
                    $("#bundle-keys").jstree("open_node",$(this));
                    return false;
                }
                $('.key-tree-node').removeClass('btn btn-primary btn-danger');
                currentNode = $(this);
                $(currentNode).addClass('btn btn-primary');
                $('#translations-group').html('Loading...');

                $.ajax({
                    url: '{{ path('translations_messages') }}',
                    type: 'post',
                    data:{
                        projectId: {{ project.id }},
                        catalog: "{{ current_catalog }}",
                        key: key
                    },
                    success: function(data){
                        if(data.result){
                            $(currentNode).removeClass('btn-primary').addClass('btn-danger');
                            $('#translations-group').html(data.html);
                            currentKey = data.key;
                        }else{
                            $('.key-tree-node').removeClass('btn btn-primary');
                            logEvent('error: '+data.reason);
                        }
                    },
                    error: function(data){
                        $('.key-tree-node').removeClass('btn btn-primary');
                        logEvent('error: '+data.reason);
                    }
                });
            });

            $('.approve').click(function(e){
                e.preventDefault();
                var id = $(this).attr('key');
                var url = '{{ path('approve_translation', {"messageId": "000"}) }}'.replace('000', id);
                $.ajax({
                    url: url,
                    type: 'post',
                    success: function(data){
                        if(data.result){
                            $('.approve[key="'+data.id+'"]')
                                .removeClass('btn-success').addClass('btn-danger')
                                .html('<i class="icon-thumbs-down"></i> {{ "button.disapprove"|trans|raw }}');
                            $('.approved_indicator[key="'+data.id+'"]')
                                    .find('i')
                                    .removeClass('icon-thumbs-down')
                                    .addClass('icon-thumbs-up');
                        }else{
                            alert(data.reason);
                        }
                        console.log(data);
                    },
                    error: function(data){
                        alert(data);
                    }
                })
            });

            $('#search').click(function(e){
                e.preventDefault();
                var search = $('input[name="search"]').val();
                console.log('searching '+search+' ...');
            });

        });
    </script>
{% endblock javascripts %}